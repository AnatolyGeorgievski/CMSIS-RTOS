# Операционная система CMSIS-RTOS R3v2 
Ядро операционной системы R3v2. Предназначена для работы на контроллерах ARM Cortex-M. Операционная система поддерживает мультизадачность, интерфейс CMSIS-RTOS. Поддерживает совместимость с С11: thread, mutex, condition,... Интерфейс C11 thread.h является нативным. 

## Характеристики

- Многозадачность и примитивы синхронизации выполнены таким образом, чтобы обспечить неблокирующее выполнение всех процессов. Lock-Free, Wait-free.
- Переключение (планирование) задач происходит в прерывании PendSV. Прерывание PendSV выполняется на хвосте любого прерывания. 
- Поддержка таймерных задач с компенсацией округления временных интервалов.
- Поддержка фоновых процессов (служб) типа сбор мусора при динамическом распределении памяти или фоновая обработка потоков сообщений. 
- Нативная поддержка очереди процессов наподобие OpenCL. Поддержка очереди позволяет реализовать модели асинхронного исполнения по событиям. При этом задачи (кернелы) не занимают стек. 
- Неблокирующие асинхронные очереди, динамическое распределение памяти malloc не блокирующее,  выделение памяти слайсами не блокирующее, без ожидания, без задержек. 
- поддержка протокола системного уровня для удаленного управления и сбора данных. 
- поддержка системного реестра, объектная модель данных. 
- поддержка бинарных форматов BACnet
- Отладка ядра и прикладных задач выполняется через подсистему Trace. На контроллерах Cortex-M поддерживается вывод отладочной информации через ITM SWO или UART.

## Введение
Интерфейс CMSIS-RTOS поддерживается, потому что стандарт. Надо отметить, что далеко не все примитивы синхронизации задач присутствующие в CMSIS задействованы в реальных задачах. На практике достаточным оказывается использоваие всего трех элементов: сигналы или флаги процессов, треды, асинхронные очереди. Практически, для реализации мультизадачности необходимо, чтобы ядро поддерживало ожидание семафора и ожидание сигналов. Все варианты ожидания ресурсов или очередей можно выстроить на семафорах, понимая под семафором - счетчик свободных рессурсов. Таким образом минимальный вариант планировщика обеспечивает ожидание флагов и семафоров. Флаги процесса являются неотъемлемой частью контекста процесса. 

Процесс - это объект у которого есть флаги, таймер ожидания, функция обработки потока. В R3 поодерживается нексолько концепций управления процессами. Процессы бывают "служебные", такие как сбор мусора или вывод системных сообщений. Такие процессы мы называем "служба", они не используют отдельный стек, выполяются в составе системного треда. Еще один вариант процессов - кернелы - элементы блочной диаграммы. В R3 поддерживается планировщик для фоновых задач с возможностью синхронизации запуска кернелов (функциональных блоков) по готовности данных и готовности исполнения, поддерживается конвейер задач подобно OpenCL. 

Ценный ресурс для контроллеров - оперативная память. По этой причине мы стараемся минимизировать использование памяти под стек. Стеки могут быть разделяемые между множеством типовых задач. Мы поддерживаем концепцию ThreadPool на системном уровне. Это означает возможность запуска неограниченного числа задач на фиксированном количестве тайм слотов (стеков).

Таймерные задачи. ОС обладает уникальным свойством. Мы поддерживаем интерфес запуска периодидических таймерных процессов с возможностью компенсации фазовой ошибки времени запуска. Таймерных процессов может быть несколько и каждый из них не препятствует и не замедляет работу другого. Эта функция в частности используется для реализации управления двигателями или для цифровой обработки сигналов. 

В остальном мы придерживаемся совместимости со стандартом C11, который предлагает свой вариант тредов. Треды C11 оказываются базовым интерфейсом на котором строится интерфейс тредов CMSIS-RTOS. Мы широко используем атомарные операции для реализации механизмов синхронизации процессов, таких как мьютексы и семафоры, в user space, без передачи управления операционной системе. Это позволяет реализовать принцип Lock-Free, Wait-free, синхронизацию задач без задержек и без блокировок.

## Интерфейсы С11
* threads.h... функции управления процессами
* tss.h... thread specific storage
* мьютексы и кондишены.

## Интерфейс CMSIS-RTOS 
Функционал операционной системы определяется набором флагов указанных в файле заголовка "cmsis_os.h". 

## Интерфейс CMSIS-RTOS v2
* osMemoryPool
* Thread Flags

## Кооперативная и вытесняющая многозадачность
Если задача выполняет дольше заданного кванта времени, происходит переключение задач. Квант времени настраивается. Реально при использовании не блокирующих вызовов, а блокирующие вызовы в системе не поддерживаются, ситуация вытестения, когда та или иная задача выполняется достаточно продолжительное время, чтобы произошло принудительное переключение задач, не реализуется. Таким образом реализуется механиз кооперативной многозадачности. Однако, мы поддерживаем уведомления - это механизм переключения задач при возникновении события в драйвере периферийного устройства, в прерывании, который подталкивает процесс переключения задач. Т.е. сразу на хвосте аппаратного прерывания может производится переключение контекстов задач, управление передается задаче, за которой закреплено взаимодействие с драйвером. 
Такое переключение выполняется с учетом приоритета задачи и обеспечивает минимальную задержку на обработку. 

## Система сбора сообщений Trace

## Вместо файловой системы
Мы старательно избегаем использовать файловую систему. Данные должны рождаться в памяти и прикладная программа ничего не должна знать про способ хранения данных. С точки зрения прикладной программы данные всегда расположены в памяти контроллера. Заменой файловой системе явяляется системный реестр, часть которого сохраняется при выключении питания. Концепция реестра совместима с адресацией объектов BACnet. Кроме того, поддерживается также механизм конфигурации устройства основанный на перемещаемых сегментах памяти. Переменная в программе может быть помечена, как часть статической конфигурации. Загрузка конфигурации происходит при включении питания, поддерживается журнал операции сохранения конфигурации при аварийном выключении. Экспериментально добавлен механизм хранения данных из реестра на носителе отображаемом в память mmаp. 

## Системное устройство (Драйвер)
open, close, ctrl, send, recv --использование данного интерфейса предполагает эксклюзивный доступ к устройству(ресурсу). Драйвер использует понятие флаг и процесс-владелец ресурса (owner). Все вызовы не блокирующие. Ожидание одного и более событий реализуется на сигналах/флагах процесса. 

## Портирование
Изначально ориентировано на использование микроконтроллеров с архитектурой ARM Cortex M3/M4/M7, M23/M33/M35P/M55/M85. Поддерживаются профили armv7-m, armv8-BASE и armv8-MAIN.  

## Развитие операционной системы
* Перенос функционала на много-ядерные платформы. 

Copyright (c) 2008-2022. Anatoly Georgivskii
